name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on tags like v1.0.0, v1.2.3, etc.

# Set to "true" in repo Settings â†’ Variables to enable code signing + notarization (requires secrets).
env:
  ENABLE_CODE_SIGNING: ${{ vars.ENABLE_CODE_SIGNING || 'false' }}

jobs:
  release:
    name: Build and Release
    runs-on: macos-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Set signing identity
        id: signing
        run: |
          if [ "${{ env.ENABLE_CODE_SIGNING }}" = "true" ]; then
            echo "identity=Developer ID Application" >> $GITHUB_OUTPUT
          else
            echo "identity=" >> $GITHUB_OUTPUT
          fi
      
      - name: Import code signing certificate
        if: env.ENABLE_CODE_SIGNING == 'true'
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.P12_PASSWORD }}
      
      - name: Show build environment
        run: |
          echo "Building version: ${{ steps.get_version.outputs.VERSION }}"
          echo "Code signing: ${{ env.ENABLE_CODE_SIGNING }}"
          xcodebuild -version
          xcode-select -p
          sw_vers
      
      - name: Build app
        run: |
          cd WorkWell
          IDENTITY="${{ steps.signing.outputs.identity }}"
          if [ -n "$IDENTITY" ]; then
            xcodebuild \
              -project WorkWell.xcodeproj \
              -scheme WorkWell \
              -configuration Release \
              -derivedDataPath ./build \
              CODE_SIGN_ENTITLEMENTS=WorkWell/WorkWell.entitlements \
              CODE_SIGN_IDENTITY="$IDENTITY" \
              CODE_SIGN_STYLE=Manual \
              OTHER_CODE_SIGN_FLAGS="--timestamp" \
              clean build
          else
            xcodebuild \
              -project WorkWell.xcodeproj \
              -scheme WorkWell \
              -configuration Release \
              -derivedDataPath ./build \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              clean build
          fi
      
      - name: Verify build
        run: |
          echo "Checking build output..."
          ls -la WorkWell/build/Build/Products/Release/
          if [ -d "WorkWell/build/Build/Products/Release/WorkWell.app" ]; then
            echo "âœ… App bundle created successfully"
          else
            echo "âŒ App bundle not found"
            exit 1
          fi
      
      - name: Notarize app
        if: env.ENABLE_CODE_SIGNING == 'true'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd WorkWell/build/Build/Products/Release
          echo "Creating zip for notary submission..."
          ditto -c -k --keepParent WorkWell.app WorkWell-notarize.zip
          echo "Submitting to Apple Notary..."
          xcrun notarytool submit WorkWell-notarize.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          echo "Stapling notarization ticket to app..."
          xcrun stapler staple "WorkWell.app"
          echo "âœ… Notarization complete"
      
      - name: Package app as ZIP
        run: |
          cd WorkWell/build/Build/Products/Release
          
          # Create a clean directory for the app
          mkdir -p WorkWell-${{ steps.get_version.outputs.VERSION }}
          cp -R WorkWell.app WorkWell-${{ steps.get_version.outputs.VERSION }}/
          
          # Create ZIP archive
          zip -r -y WorkWell-${{ steps.get_version.outputs.VERSION }}.zip WorkWell-${{ steps.get_version.outputs.VERSION }}
          
          # Move to artifacts directory (repo root: Release -> Products -> Build -> build -> WorkWell -> root)
          mkdir -p ../../../../../artifacts
          mv WorkWell-${{ steps.get_version.outputs.VERSION }}.zip ../../../../../artifacts/
          
          echo "âœ… ZIP package created"
      
      - name: Create DMG installer
        run: |
          cd WorkWell/build/Build/Products/Release
          
          # Create temporary directory for DMG contents
          mkdir -p dmg_contents
          cp -R WorkWell.app dmg_contents/
          
          # Create Applications symlink for easy installation
          ln -s /Applications dmg_contents/Applications
          
          # Create DMG using hdiutil
          hdiutil create -volname "WorkWell ${{ steps.get_version.outputs.VERSION }}" \
            -srcfolder dmg_contents \
            -ov -format UDZO \
            WorkWell-${{ steps.get_version.outputs.VERSION }}.dmg
          
          mv WorkWell-${{ steps.get_version.outputs.VERSION }}.dmg ../../../../../artifacts/
          
          echo "âœ… DMG installer created"
      
      - name: Generate checksums
        run: |
          cd artifacts
          shasum -a 256 WorkWell-${{ steps.get_version.outputs.VERSION }}.zip > checksums.txt
          shasum -a 256 WorkWell-${{ steps.get_version.outputs.VERSION }}.dmg >> checksums.txt
          cat checksums.txt
      
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << RELEASE_NOTES_EOF
          ## WorkWell (WorkWell) ${{ steps.get_version.outputs.VERSION }}
          
          **WorkWell** is a macOS app that helps you work healthier: reminders to **drink water**, **rest your eyes** (20â€“20â€“20 rule), and **stand up & move**. Built for desk workers, developers, designers, and students.
          
          ### ðŸ“¦ Installation
          
          **Option 1: DMG Installer (Recommended)**
          1. Download \`WorkWell-${{ steps.get_version.outputs.VERSION }}.dmg\`
          2. Open the DMG file
          3. Drag **WorkWell** into **Applications**
          4. Launch from Applications
          
          **Option 2: ZIP Archive**
          1. Download \`WorkWell-${{ steps.get_version.outputs.VERSION }}.zip\`
          2. Extract the archive
          3. Move **WorkWell.app** to **Applications**
          4. Launch from Applications
          
          ### âš™ï¸ System Requirements
          
          - macOS 14.0 (Sonoma) or later
          - Apple Silicon or Intel processor
          
          ### ðŸ” Security Note
          
          **Signed & notarized builds** (when enabled for the repo): open the app normally.  
          **Unsigned builds**: on first launch, right-click (or Control-click) **WorkWell.app** â†’ **Open** â†’ **Open** in the dialog.
          
          ### âœ¨ Features
          
          - ðŸ’§ **Water reminders** â€“ Daily goal by weight, reminders by interval or work hours, tracking & charts
          - ðŸ‘€ **Eye rest (20â€“20â€“20)** â€“ Every 20 min, look 20 feet away for 20 seconds; countdown, light/focus modes
          - ðŸš¶ **Stand & move** â€“ Remind every 30/45/60 min; stretch/walk tips; â€œin meetingâ€ pause
          - ðŸ“Š **Stats & streaks** â€“ Track water, eye rest, movement; daily streaks and compliance
          - âš™ï¸ Work hours, notification style (banner/sound/snooze), light/dark, Vietnamese/English
          
          ### ðŸ“ Checksums (SHA-256)
          
          \`\`\`
          $(cat artifacts/checksums.txt)
          \`\`\`
          
          ### ðŸ› Issues & feedback
          
          [Open an issue](https://github.com/${{ github.repository }}/issues) if you find a bug or have a suggestion.
          
          ---
          
          **WorkWell** â€“ Stay healthy while you work. ðŸ’§ðŸ‘€ðŸš¶
          RELEASE_NOTES_EOF
          echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: WorkWell ${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'alpha') || contains(steps.get_version.outputs.VERSION, 'beta') || contains(steps.get_version.outputs.VERSION, 'rc') }}
          files: |
            artifacts/WorkWell-${{ steps.get_version.outputs.VERSION }}.zip
            artifacts/WorkWell-${{ steps.get_version.outputs.VERSION }}.dmg
            artifacts/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release summary
        run: |
          echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ZIP Archive" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DMG Installer" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Checksums" >> $GITHUB_STEP_SUMMARY
